name: Laravel Build & Integrity Check

on:
  push:
    branches: [ "main", "development" ]
  pull_request:
    branches: [ "main", "development" ]

jobs:
  build-and-validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup PHP Environment
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite
        coverage: none

    - name: Install Composer Dependencies
      run: composer install --prefer-dist --no-progress --no-suggest

    - name: Prepare Application Environment
      run: |
        cp .env.example .env
        php artisan key:generate

    - name: Fix Directory Permissions
      run: chmod -R 777 storage bootstrap/cache

    # --- THE SMART PART ---
    # We use SQLite (in-memory) to test your database migrations.
    # This proves your database structure is correct without needing a MySQL server.
    - name: Validate Database Schema (SQLite)
      env:
        DB_CONNECTION: sqlite
        DB_DATABASE: ':memory:'
      run: php artisan migrate --force

    # This checks your code for syntax errors (Professional Linting)
    - name: Code Quality Check
      run: find app routes config -name "*.php" -print0 | xargs -0 -n1 php -l